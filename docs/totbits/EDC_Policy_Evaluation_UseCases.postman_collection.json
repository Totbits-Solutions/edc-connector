{
  "info": {
    "name": "EDC - Casos de Uso Evaluacion de Politicas",
    "description": "Coleccion con los 4 casos de uso de evaluacion de politicas en el EDC Connector.\n\nEjecutar las carpetas en orden:\n1. Setup Proveedor — Crear assets, policies y contract definitions\n2. Caso 1: catalog.request\n3. Caso 2: contract.negotiation\n4. Caso 3: transfer.process\n5. Caso 4: policy.monitor\n\nConfigurar las variables de la coleccion antes de ejecutar.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "PROVIDER_MANAGEMENT_URL",
      "value": "http://localhost:18181/api/management",
      "description": "Management API del proveedor"
    },
    {
      "key": "CONSUMER_MANAGEMENT_URL",
      "value": "http://localhost:28181/api/management",
      "description": "Management API del consumidor"
    },
    {
      "key": "PROVIDER_DSP_URL",
      "value": "http://localhost:18282/api/dsp",
      "description": "Protocolo DSP del proveedor (donde el consumidor contacta)"
    },
    {
      "key": "CONSUMER_CALLBACK_URL",
      "value": "http://localhost:28181/api/callbacks",
      "description": "URL de callbacks del consumidor"
    },
    {
      "key": "PROVIDER_ID",
      "value": "proveedor-id",
      "description": "Participant ID del proveedor"
    },
    {
      "key": "CONSUMER_RECEIVE_URL",
      "value": "http://localhost:29999/api/receive-data",
      "description": "Endpoint del consumidor para recibir datos (PUSH)"
    },
    {
      "key": "API_VERSION",
      "value": "v3",
      "description": "Version del Management API (v3 o v4beta)"
    },
    {
      "key": "PROTOCOL",
      "value": "dataspace-protocol-http",
      "description": "Protocolo DSP a usar"
    },
    {
      "key": "negotiation_id",
      "value": "",
      "description": "Se rellena automaticamente al iniciar negociacion"
    },
    {
      "key": "agreement_id",
      "value": "",
      "description": "Se rellena automaticamente al obtener el agreement"
    },
    {
      "key": "transfer_id",
      "value": "",
      "description": "Se rellena automaticamente al iniciar transferencia"
    },
    {
      "key": "offer_id",
      "value": "",
      "description": "Se rellena automaticamente al pedir el catalogo"
    }
  ],
  "item": [
    {
      "name": "0. Setup Proveedor",
      "description": "Crear assets, policy definitions y contract definitions en el proveedor. Ejecutar todos los requests de esta carpeta antes de pasar a los casos de uso.",
      "item": [
        {
          "name": "0.1 Crear Asset - Dataset Publico",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/assets" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"Asset\",\n  \"@id\": \"dataset-publico\",\n  \"properties\": {\n    \"name\": \"Dataset Publico de Transporte\",\n    \"description\": \"Datos abiertos de transporte urbano\",\n    \"contenttype\": \"application/json\"\n  },\n  \"dataAddress\": {\n    \"@type\": \"DataAddress\",\n    \"type\": \"HttpData\",\n    \"baseUrl\": \"https://datos.proveedor.com/transporte\"\n  }\n}"
            }
          }
        },
        {
          "name": "0.2 Crear Asset - Dataset Partners",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/assets" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"Asset\",\n  \"@id\": \"dataset-partners\",\n  \"properties\": {\n    \"name\": \"Dataset Premium de Energia\",\n    \"description\": \"Datos de consumo energetico - solo partners gold\",\n    \"contenttype\": \"application/json\"\n  },\n  \"dataAddress\": {\n    \"@type\": \"DataAddress\",\n    \"type\": \"HttpData\",\n    \"baseUrl\": \"https://datos.proveedor.com/energia\"\n  }\n}"
            }
          }
        },
        {
          "name": "0.3 Crear Asset - Dataset Streaming IoT",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/assets" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"Asset\",\n  \"@id\": \"dataset-streaming-iot\",\n  \"properties\": {\n    \"name\": \"Stream IoT Sensores\",\n    \"description\": \"Datos en tiempo real de sensores IoT\",\n    \"contenttype\": \"application/json\"\n  },\n  \"dataAddress\": {\n    \"@type\": \"DataAddress\",\n    \"type\": \"HttpData\",\n    \"baseUrl\": \"https://datos.proveedor.com/iot-stream\"\n  }\n}"
            }
          }
        },
        {
          "name": "0.4 Crear Policy - Acceso Abierto",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/policydefinitions" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"PolicyDefinition\",\n  \"@id\": \"policy-acceso-abierto\",\n  \"policy\": {\n    \"@context\": \"http://www.w3.org/ns/odrl.jsonld\",\n    \"@type\": \"Set\",\n    \"permission\": [\n      {\n        \"action\": \"use\"\n      }\n    ]\n  }\n}"
            }
          }
        },
        {
          "name": "0.5 Crear Policy - Acceso Solo Partners Gold",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/policydefinitions" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"PolicyDefinition\",\n  \"@id\": \"policy-acceso-partners-gold\",\n  \"policy\": {\n    \"@context\": \"http://www.w3.org/ns/odrl.jsonld\",\n    \"@type\": \"Set\",\n    \"permission\": [\n      {\n        \"action\": \"use\",\n        \"constraint\": [\n          {\n            \"leftOperand\": \"partnerLevel\",\n            \"operator\": \"eq\",\n            \"rightOperand\": \"gold\"\n          }\n        ]\n      }\n    ]\n  }\n}"
            }
          }
        },
        {
          "name": "0.6 Crear Policy - Acceso Denegado",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/policydefinitions" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"PolicyDefinition\",\n  \"@id\": \"policy-acceso-denegado\",\n  \"policy\": {\n    \"@context\": \"http://www.w3.org/ns/odrl.jsonld\",\n    \"@type\": \"Set\",\n    \"prohibition\": [\n      {\n        \"action\": \"use\"\n      }\n    ]\n  }\n}"
            }
          }
        },
        {
          "name": "0.7 Crear Policy - Contrato Estandar (sin restricciones)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/policydefinitions" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"PolicyDefinition\",\n  \"@id\": \"policy-contrato-estandar\",\n  \"policy\": {\n    \"@context\": \"http://www.w3.org/ns/odrl.jsonld\",\n    \"@type\": \"Set\",\n    \"permission\": [\n      {\n        \"action\": \"use\"\n      }\n    ]\n  }\n}"
            }
          }
        },
        {
          "name": "0.8 Crear Policy - Contrato Temporal 7 Dias",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/policydefinitions" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"PolicyDefinition\",\n  \"@id\": \"policy-contrato-7-dias\",\n  \"policy\": {\n    \"@context\": \"http://www.w3.org/ns/odrl.jsonld\",\n    \"@type\": \"Set\",\n    \"permission\": [\n      {\n        \"action\": \"use\",\n        \"constraint\": [\n          {\n            \"leftOperand\": \"edc:inForceDate\",\n            \"operator\": \"gteq\",\n            \"rightOperand\": \"contractAgreement+0s\"\n          },\n          {\n            \"leftOperand\": \"edc:inForceDate\",\n            \"operator\": \"lteq\",\n            \"rightOperand\": \"contractAgreement+7d\"\n          }\n        ]\n      }\n    ]\n  }\n}"
            }
          }
        },
        {
          "name": "0.9 Crear ContractDefinition - Publico",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/contractdefinitions" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"ContractDefinition\",\n  \"@id\": \"contrato-publico\",\n  \"accessPolicyId\": \"policy-acceso-abierto\",\n  \"contractPolicyId\": \"policy-contrato-estandar\",\n  \"assetsSelector\": [\n    {\n      \"@type\": \"Criterion\",\n      \"operandLeft\": \"https://w3id.org/edc/v0.0.1/ns/id\",\n      \"operator\": \"=\",\n      \"operandRight\": \"dataset-publico\"\n    }\n  ]\n}"
            }
          }
        },
        {
          "name": "0.10 Crear ContractDefinition - Partners Gold",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/contractdefinitions" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"ContractDefinition\",\n  \"@id\": \"contrato-partners\",\n  \"accessPolicyId\": \"policy-acceso-partners-gold\",\n  \"contractPolicyId\": \"policy-contrato-estandar\",\n  \"assetsSelector\": [\n    {\n      \"@type\": \"Criterion\",\n      \"operandLeft\": \"https://w3id.org/edc/v0.0.1/ns/id\",\n      \"operator\": \"=\",\n      \"operandRight\": \"dataset-partners\"\n    }\n  ]\n}"
            }
          }
        },
        {
          "name": "0.11 Crear ContractDefinition - Streaming IoT (7 dias)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/contractdefinitions" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"ContractDefinition\",\n  \"@id\": \"contrato-streaming-temporal\",\n  \"accessPolicyId\": \"policy-acceso-abierto\",\n  \"contractPolicyId\": \"policy-contrato-7-dias\",\n  \"assetsSelector\": [\n    {\n      \"@type\": \"Criterion\",\n      \"operandLeft\": \"https://w3id.org/edc/v0.0.1/ns/id\",\n      \"operator\": \"=\",\n      \"operandRight\": \"dataset-streaming-iot\"\n    }\n  ]\n}"
            }
          }
        }
      ]
    },
    {
      "name": "1. Caso 1 - catalog.request",
      "description": "Evaluacion de access policies al solicitar el catalogo.\n\nEl proveedor filtra los assets visibles segun la access policy de cada ContractDefinition.\n- dataset-publico: visible para todos\n- dataset-partners: solo visible para partners gold\n- dataset-streaming-iot: visible para todos",
      "item": [
        {
          "name": "1.1 Solicitar Catalogo Completo",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "var jsonData = pm.response.json();",
                  "",
                  "// Intentar extraer el primer offerId del catalogo",
                  "try {",
                  "    var datasets = jsonData['dcat:dataset'];",
                  "    if (datasets && datasets.length > 0) {",
                  "        var firstDataset = datasets[0];",
                  "        var policies = firstDataset['odrl:hasPolicy'];",
                  "        if (policies) {",
                  "            var policy = Array.isArray(policies) ? policies[0] : policies;",
                  "            var offerId = policy['@id'];",
                  "            if (offerId) {",
                  "                pm.collectionVariables.set('offer_id', offerId);",
                  "                console.log('offer_id guardado: ' + offerId);",
                  "            }",
                  "        }",
                  "    }",
                  "} catch(e) {",
                  "    console.log('No se pudo extraer offer_id automaticamente: ' + e.message);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/catalog/request" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"CatalogRequest\",\n  \"counterPartyAddress\": \"{{PROVIDER_DSP_URL}}\",\n  \"counterPartyId\": \"{{PROVIDER_ID}}\",\n  \"protocol\": \"{{PROTOCOL}}\"\n}"
            }
          }
        },
        {
          "name": "1.2 Solicitar Catalogo - Filtrar por Asset ID",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/catalog/request" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"CatalogRequest\",\n  \"counterPartyAddress\": \"{{PROVIDER_DSP_URL}}\",\n  \"counterPartyId\": \"{{PROVIDER_ID}}\",\n  \"protocol\": \"{{PROTOCOL}}\",\n  \"querySpec\": {\n    \"@type\": \"QuerySpec\",\n    \"filterExpression\": [\n      {\n        \"@type\": \"Criterion\",\n        \"operandLeft\": \"https://w3id.org/edc/v0.0.1/ns/id\",\n        \"operator\": \"=\",\n        \"operandRight\": \"dataset-publico\"\n      }\n    ]\n  }\n}"
            }
          }
        },
        {
          "name": "1.3 Solicitar Dataset Especifico",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/catalog/dataset/request" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"DatasetRequest\",\n  \"@id\": \"dataset-publico\",\n  \"counterPartyAddress\": \"{{PROVIDER_DSP_URL}}\",\n  \"counterPartyId\": \"{{PROVIDER_ID}}\",\n  \"protocol\": \"{{PROTOCOL}}\"\n}"
            }
          }
        }
      ]
    },
    {
      "name": "2. Caso 2 - contract.negotiation",
      "description": "Evaluacion de contract policies durante la negociacion.\n\nEl consumidor toma la oferta del catalogo e inicia una negociacion. El proveedor re-evalua access policy + contract policy.\n\nIMPORTANTE: Copiar el offerId de la respuesta del catalogo (paso 1.1) a la variable offer_id, o rellenar manualmente el campo policy.@id en el paso 2.1.",
      "item": [
        {
          "name": "2.1 Iniciar Negociacion de Contrato",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "var jsonData = pm.response.json();",
                  "if (jsonData['@id']) {",
                  "    pm.collectionVariables.set('negotiation_id', jsonData['@id']);",
                  "    console.log('negotiation_id guardado: ' + jsonData['@id']);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/contractnegotiations" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"ContractRequest\",\n  \"counterPartyAddress\": \"{{PROVIDER_DSP_URL}}\",\n  \"protocol\": \"{{PROTOCOL}}\",\n  \"policy\": {\n    \"@context\": \"http://www.w3.org/ns/odrl.jsonld\",\n    \"@type\": \"odrl:Offer\",\n    \"@id\": \"{{offer_id}}\",\n    \"assigner\": \"{{PROVIDER_ID}}\",\n    \"target\": \"dataset-publico\",\n    \"permission\": [\n      {\n        \"action\": \"use\"\n      }\n    ]\n  },\n  \"callbackAddresses\": [\n    {\n      \"transactional\": false,\n      \"uri\": \"{{CONSUMER_CALLBACK_URL}}\",\n      \"events\": [\"contract.negotiation\"]\n    }\n  ]\n}"
            }
          }
        },
        {
          "name": "2.2 Consultar Estado de Negociacion",
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/contractnegotiations/{{negotiation_id}}/state" }
          }
        },
        {
          "name": "2.3 Ver Detalles de Negociacion",
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/contractnegotiations/{{negotiation_id}}" }
          }
        },
        {
          "name": "2.4 Obtener Agreement de la Negociacion",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "var jsonData = pm.response.json();",
                  "if (jsonData['@id']) {",
                  "    pm.collectionVariables.set('agreement_id', jsonData['@id']);",
                  "    console.log('agreement_id guardado: ' + jsonData['@id']);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/contractnegotiations/{{negotiation_id}}/agreement" }
          }
        },
        {
          "name": "2.5 Listar Todas las Negociaciones",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/contractnegotiations/request" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"QuerySpec\",\n  \"offset\": 0,\n  \"limit\": 10,\n  \"sortOrder\": \"DESC\",\n  \"sortField\": \"createdAt\"\n}"
            }
          }
        },
        {
          "name": "2.6 Terminar Negociacion (opcional)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/contractnegotiations/{{negotiation_id}}/terminate" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"TerminateNegotiation\",\n  \"@id\": \"{{negotiation_id}}\",\n  \"reason\": \"Las condiciones no son aceptables\"\n}"
            }
          }
        }
      ]
    },
    {
      "name": "3. Caso 3 - transfer.process",
      "description": "Re-evaluacion de la policy del agreement al iniciar transferencia.\n\nEl proveedor verifica que la policy sigue siendo valida en el momento actual.\n\nPrerrequisito: tener un agreement_id del caso 2.",
      "item": [
        {
          "name": "3.1 Iniciar Transferencia PUSH",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "var jsonData = pm.response.json();",
                  "if (jsonData['@id']) {",
                  "    pm.collectionVariables.set('transfer_id', jsonData['@id']);",
                  "    console.log('transfer_id guardado: ' + jsonData['@id']);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/transferprocesses" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"TransferRequest\",\n  \"protocol\": \"{{PROTOCOL}}\",\n  \"counterPartyAddress\": \"{{PROVIDER_DSP_URL}}\",\n  \"contractId\": \"{{agreement_id}}\",\n  \"transferType\": \"HttpData-PUSH\",\n  \"dataDestination\": {\n    \"@type\": \"DataAddress\",\n    \"type\": \"HttpData\",\n    \"baseUrl\": \"{{CONSUMER_RECEIVE_URL}}\"\n  },\n  \"callbackAddresses\": [\n    {\n      \"transactional\": false,\n      \"uri\": \"{{CONSUMER_CALLBACK_URL}}\",\n      \"events\": [\"transfer.process.started\", \"transfer.process.completed\", \"transfer.process.terminated\"]\n    }\n  ]\n}"
            }
          }
        },
        {
          "name": "3.2 Iniciar Transferencia PULL (alternativa)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "var jsonData = pm.response.json();",
                  "if (jsonData['@id']) {",
                  "    pm.collectionVariables.set('transfer_id', jsonData['@id']);",
                  "    console.log('transfer_id guardado: ' + jsonData['@id']);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/transferprocesses" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"TransferRequest\",\n  \"protocol\": \"{{PROTOCOL}}\",\n  \"counterPartyAddress\": \"{{PROVIDER_DSP_URL}}\",\n  \"contractId\": \"{{agreement_id}}\",\n  \"transferType\": \"HttpData-PULL\",\n  \"callbackAddresses\": [\n    {\n      \"transactional\": false,\n      \"uri\": \"{{CONSUMER_CALLBACK_URL}}\",\n      \"events\": [\"transfer.process.started\", \"transfer.process.completed\", \"transfer.process.terminated\"]\n    }\n  ]\n}"
            }
          }
        },
        {
          "name": "3.3 Consultar Estado de Transferencia",
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/transferprocesses/{{transfer_id}}/state" }
          }
        },
        {
          "name": "3.4 Ver Detalles de Transferencia",
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/transferprocesses/{{transfer_id}}" }
          }
        },
        {
          "name": "3.5 Listar Todas las Transferencias",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/transferprocesses/request" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"QuerySpec\",\n  \"offset\": 0,\n  \"limit\": 10,\n  \"sortOrder\": \"DESC\",\n  \"sortField\": \"createdAt\"\n}"
            }
          }
        },
        {
          "name": "3.6 Suspender Transferencia",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/transferprocesses/{{transfer_id}}/suspend" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"SuspendTransfer\",\n  \"reason\": \"Mantenimiento programado del sistema receptor\"\n}"
            }
          }
        },
        {
          "name": "3.7 Reanudar Transferencia",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/transferprocesses/{{transfer_id}}/resume" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" }\n}"
            }
          }
        },
        {
          "name": "3.8 Terminar Transferencia",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/transferprocesses/{{transfer_id}}/terminate" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"TerminateTransfer\",\n  \"reason\": \"Ya no necesitamos estos datos\"\n}"
            }
          }
        }
      ]
    },
    {
      "name": "4. Caso 4 - policy.monitor",
      "description": "Vigilancia continua de politicas en transferencias activas.\n\nEl Policy Monitor es automatico (no tiene endpoints propios). Para demostrarlo:\n1. Negociar un contrato con policy temporal (dataset-streaming-iot, 7 dias)\n2. Iniciar transferencia\n3. Monitorear el estado — el Policy Monitor terminara la transferencia cuando expire\n\nPara probar la expiracion rapida, usar una policy con duracion corta (ej: contractAgreement+60s).",
      "item": [
        {
          "name": "4.0 (Opcional) Crear Policy Expiracion Rapida (60s)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/policydefinitions" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"PolicyDefinition\",\n  \"@id\": \"policy-contrato-60-segundos\",\n  \"policy\": {\n    \"@context\": \"http://www.w3.org/ns/odrl.jsonld\",\n    \"@type\": \"Set\",\n    \"permission\": [\n      {\n        \"action\": \"use\",\n        \"constraint\": [\n          {\n            \"leftOperand\": \"edc:inForceDate\",\n            \"operator\": \"gteq\",\n            \"rightOperand\": \"contractAgreement+0s\"\n          },\n          {\n            \"leftOperand\": \"edc:inForceDate\",\n            \"operator\": \"lteq\",\n            \"rightOperand\": \"contractAgreement+60s\"\n          }\n        ]\n      }\n    ]\n  }\n}"
            }
          }
        },
        {
          "name": "4.0b (Opcional) Actualizar ContractDef con policy 60s",
          "request": {
            "method": "PUT",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/contractdefinitions" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"ContractDefinition\",\n  \"@id\": \"contrato-streaming-temporal\",\n  \"accessPolicyId\": \"policy-acceso-abierto\",\n  \"contractPolicyId\": \"policy-contrato-60-segundos\",\n  \"assetsSelector\": [\n    {\n      \"@type\": \"Criterion\",\n      \"operandLeft\": \"https://w3id.org/edc/v0.0.1/ns/id\",\n      \"operator\": \"=\",\n      \"operandRight\": \"dataset-streaming-iot\"\n    }\n  ]\n}"
            }
          }
        },
        {
          "name": "4.1 Solicitar Catalogo (ver dataset-streaming-iot)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "var jsonData = pm.response.json();",
                  "try {",
                  "    var datasets = jsonData['dcat:dataset'];",
                  "    if (datasets) {",
                  "        var list = Array.isArray(datasets) ? datasets : [datasets];",
                  "        for (var i = 0; i < list.length; i++) {",
                  "            if (list[i]['@id'] === 'dataset-streaming-iot') {",
                  "                var policies = list[i]['odrl:hasPolicy'];",
                  "                var policy = Array.isArray(policies) ? policies[0] : policies;",
                  "                if (policy && policy['@id']) {",
                  "                    pm.collectionVariables.set('offer_id', policy['@id']);",
                  "                    console.log('offer_id (streaming) guardado: ' + policy['@id']);",
                  "                }",
                  "            }",
                  "        }",
                  "    }",
                  "} catch(e) {",
                  "    console.log('No se pudo extraer offer_id: ' + e.message);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/catalog/request" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"CatalogRequest\",\n  \"counterPartyAddress\": \"{{PROVIDER_DSP_URL}}\",\n  \"counterPartyId\": \"{{PROVIDER_ID}}\",\n  \"protocol\": \"{{PROTOCOL}}\",\n  \"querySpec\": {\n    \"@type\": \"QuerySpec\",\n    \"filterExpression\": [\n      {\n        \"@type\": \"Criterion\",\n        \"operandLeft\": \"https://w3id.org/edc/v0.0.1/ns/id\",\n        \"operator\": \"=\",\n        \"operandRight\": \"dataset-streaming-iot\"\n      }\n    ]\n  }\n}"
            }
          }
        },
        {
          "name": "4.2 Negociar Contrato Streaming",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "var jsonData = pm.response.json();",
                  "if (jsonData['@id']) {",
                  "    pm.collectionVariables.set('negotiation_id', jsonData['@id']);",
                  "    console.log('negotiation_id guardado: ' + jsonData['@id']);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/contractnegotiations" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"ContractRequest\",\n  \"counterPartyAddress\": \"{{PROVIDER_DSP_URL}}\",\n  \"protocol\": \"{{PROTOCOL}}\",\n  \"policy\": {\n    \"@context\": \"http://www.w3.org/ns/odrl.jsonld\",\n    \"@type\": \"odrl:Offer\",\n    \"@id\": \"{{offer_id}}\",\n    \"assigner\": \"{{PROVIDER_ID}}\",\n    \"target\": \"dataset-streaming-iot\",\n    \"permission\": [\n      {\n        \"action\": \"use\",\n        \"constraint\": [\n          {\n            \"leftOperand\": \"edc:inForceDate\",\n            \"operator\": \"gteq\",\n            \"rightOperand\": \"contractAgreement+0s\"\n          },\n          {\n            \"leftOperand\": \"edc:inForceDate\",\n            \"operator\": \"lteq\",\n            \"rightOperand\": \"contractAgreement+7d\"\n          }\n        ]\n      }\n    ]\n  },\n  \"callbackAddresses\": [\n    {\n      \"transactional\": false,\n      \"uri\": \"{{CONSUMER_CALLBACK_URL}}\",\n      \"events\": [\"contract.negotiation\"]\n    }\n  ]\n}"
            }
          }
        },
        {
          "name": "4.3 Esperar Negociacion FINALIZED",
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/contractnegotiations/{{negotiation_id}}/state" }
          }
        },
        {
          "name": "4.4 Obtener Agreement",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "var jsonData = pm.response.json();",
                  "if (jsonData['@id']) {",
                  "    pm.collectionVariables.set('agreement_id', jsonData['@id']);",
                  "    console.log('agreement_id guardado: ' + jsonData['@id']);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/contractnegotiations/{{negotiation_id}}/agreement" }
          }
        },
        {
          "name": "4.5 Iniciar Transferencia Streaming (PULL)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "var jsonData = pm.response.json();",
                  "if (jsonData['@id']) {",
                  "    pm.collectionVariables.set('transfer_id', jsonData['@id']);",
                  "    console.log('transfer_id guardado: ' + jsonData['@id']);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/transferprocesses" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"TransferRequest\",\n  \"protocol\": \"{{PROTOCOL}}\",\n  \"counterPartyAddress\": \"{{PROVIDER_DSP_URL}}\",\n  \"contractId\": \"{{agreement_id}}\",\n  \"transferType\": \"HttpData-PULL\",\n  \"callbackAddresses\": [\n    {\n      \"transactional\": false,\n      \"uri\": \"{{CONSUMER_CALLBACK_URL}}\",\n      \"events\": [\"transfer.process.started\", \"transfer.process.terminated\"]\n    }\n  ]\n}"
            }
          }
        },
        {
          "name": "4.6 Verificar Estado (deberia ser STARTED)",
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/transferprocesses/{{transfer_id}}/state" }
          }
        },
        {
          "name": "4.7 Verificar Estado (tras expiracion → TERMINATED)",
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/transferprocesses/{{transfer_id}}/state" }
          }
        },
        {
          "name": "4.8 Ver Detalles Transferencia (ver errorDetail)",
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{CONSUMER_MANAGEMENT_URL}}/{{API_VERSION}}/transferprocesses/{{transfer_id}}" }
          }
        }
      ]
    },
    {
      "name": "5. Consultas Auxiliares (Proveedor)",
      "description": "Endpoints utiles para verificar el estado en el lado del proveedor.",
      "item": [
        {
          "name": "5.1 Listar Assets del Proveedor",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/assets/request" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"QuerySpec\",\n  \"offset\": 0,\n  \"limit\": 50\n}"
            }
          }
        },
        {
          "name": "5.2 Listar Policies del Proveedor",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/policydefinitions/request" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"QuerySpec\",\n  \"offset\": 0,\n  \"limit\": 50\n}"
            }
          }
        },
        {
          "name": "5.3 Listar Contract Definitions del Proveedor",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/contractdefinitions/request" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"QuerySpec\",\n  \"offset\": 0,\n  \"limit\": 50\n}"
            }
          }
        },
        {
          "name": "5.4 Listar Contract Agreements del Proveedor",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/contractagreements/request" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"QuerySpec\",\n  \"offset\": 0,\n  \"limit\": 50\n}"
            }
          }
        },
        {
          "name": "5.5 Listar Transferencias del Proveedor",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/transferprocesses/request" },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"@context\": { \"@vocab\": \"https://w3id.org/edc/v0.0.1/ns/\" },\n  \"@type\": \"QuerySpec\",\n  \"offset\": 0,\n  \"limit\": 50\n}"
            }
          }
        },
        {
          "name": "5.6 Eliminar Asset",
          "request": {
            "method": "DELETE",
            "header": [],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/assets/dataset-publico" }
          }
        },
        {
          "name": "5.7 Eliminar Policy Definition",
          "request": {
            "method": "DELETE",
            "header": [],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/policydefinitions/policy-acceso-abierto" }
          }
        },
        {
          "name": "5.8 Eliminar Contract Definition",
          "request": {
            "method": "DELETE",
            "header": [],
            "url": { "raw": "{{PROVIDER_MANAGEMENT_URL}}/{{API_VERSION}}/contractdefinitions/contrato-publico" }
          }
        }
      ]
    }
  ]
}
